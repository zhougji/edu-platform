(window["webpackJsonp"]=window["webpackJsonp"]||[]).push([["chunk-750c3616"],{"69db":function(t,e,s){"use strict";s("f2db")},bb51:function(t,e,s){"use strict";s.r(e);var o=function(){var t=this,e=t._self._c;return e("div",{staticClass:"dashboard-container"},[e("el-row",{staticClass:"welcome-row",attrs:{gutter:20}},[e("el-col",{attrs:{span:24}},[e("el-card",{staticClass:"welcome-card",attrs:{shadow:"never"}},[e("h2",[t._v("欢迎回来, "+t._s(t.teacherName||"老师")+"!")]),e("p",[t._v("查看您的待办事项和教学概览。")])])],1)],1),e("el-row",{attrs:{gutter:20}},[e("el-col",{attrs:{xs:24,sm:12,md:8}},[e("el-card",{staticClass:"stat-card stat-card-videos",attrs:{shadow:"hover"}},[e("div",{staticClass:"stat-icon"},[e("i",{staticClass:"el-icon-video-camera"})]),e("div",{staticClass:"stat-content"},[e("div",{staticClass:"stat-title"},[t._v("视频资源")]),e("div",{staticClass:"stat-value"},[t._v(t._s(t.videoCount))]),e("router-link",{staticClass:"stat-link",attrs:{to:"/resources"}},[t._v("管理视频 →")])],1)])],1),e("el-col",{attrs:{xs:24,sm:12,md:8}},[e("el-card",{staticClass:"stat-card stat-card-pending",attrs:{shadow:"hover"}},[e("div",{staticClass:"stat-icon"},[e("i",{staticClass:"el-icon-bell"})]),e("div",{staticClass:"stat-content"},[e("div",{staticClass:"stat-title"},[t._v("待处理辅导")]),e("div",{staticClass:"stat-value"},[t._v(t._s(t.pendingRequestCount))]),e("el-button",{staticClass:"stat-link",attrs:{type:"text"},on:{click:t.goToPendingConsultations}},[t._v("处理请求 →")])],1)])],1),e("el-col",{attrs:{xs:24,sm:12,md:8}},[e("el-card",{staticClass:"stat-card stat-card-processed",attrs:{shadow:"hover"}},[e("div",{staticClass:"stat-icon"},[e("i",{staticClass:"el-icon-finished"})]),e("div",{staticClass:"stat-content"},[e("div",{staticClass:"stat-title"},[t._v("已处理请求")]),e("div",{staticClass:"stat-value"},[t._v(t._s(t.processedRequestCount))]),e("span",{staticClass:"stat-link inactive"},[t._v("(历史记录)")])])])],1)],1),e("el-row",{attrs:{gutter:20}},[e("el-col",{attrs:{xs:24,md:14}},[e("el-card",{staticClass:"dashboard-card",attrs:{shadow:"never"}},[e("div",{staticClass:"clearfix",attrs:{slot:"header"},slot:"header"},[e("span",[t._v("最近上传的视频")]),e("el-button",{staticStyle:{float:"right",padding:"3px 0"},attrs:{type:"text"},on:{click:t.goToResources}},[t._v("查看全部")])],1),e("el-table",{directives:[{name:"loading",rawName:"v-loading",value:t.loading.videos,expression:"loading.videos"}],staticStyle:{width:"100%"},attrs:{data:t.recentVideos,height:"300px"}},[e("el-table-column",{attrs:{prop:"title",label:"标题","show-overflow-tooltip":""}}),e("el-table-column",{attrs:{prop:"subject",label:"科目",width:"100"}}),e("el-table-column",{attrs:{prop:"grade",label:"年级",width:"100"}}),e("el-table-column",{attrs:{label:"上传日期",width:"140"},scopedSlots:t._u([{key:"default",fn:function(s){return[e("span",[t._v(t._s(t.formatDate(s.row.createdAt)))])]}}])}),e("el-table-column",{attrs:{label:"操作",width:"80"},scopedSlots:t._u([{key:"default",fn:function(s){return[e("el-button",{attrs:{type:"primary",icon:"el-icon-edit",size:"mini",circle:""},on:{click:function(e){return t.editVideo(s.row.id)}}})]}}])})],1),t.loading.videos||0!==t.recentVideos.length?t._e():e("div",{staticClass:"empty-state"},[t._v(" 暂无最近上传的视频。 "),e("el-button",{staticStyle:{"margin-left":"10px"},attrs:{type:"primary",size:"small"},on:{click:t.goToResources}},[t._v("上传第一个视频")])],1)],1)],1),e("el-col",{attrs:{xs:24,md:10}},[e("el-card",{staticClass:"dashboard-card",attrs:{shadow:"never"}},[e("div",{staticClass:"clearfix",attrs:{slot:"header"},slot:"header"},[e("span",[t._v("待处理辅导请求")]),e("el-button",{staticStyle:{float:"right",padding:"3px 0"},attrs:{type:"text"},on:{click:t.goToPendingConsultations}},[t._v("查看所有待处理")])],1),e("div",{directives:[{name:"loading",rawName:"v-loading",value:t.loading.requests,expression:"loading.requests"}],staticClass:"pending-requests-list"},[e("el-scrollbar",{attrs:{height:"300px"}},[t.pendingRequests.length>0?e("div",t._l(t.pendingRequests,(function(s){var o,n;return e("div",{key:s.id,staticClass:"pending-request-item"},[e("el-avatar",{staticClass:"student-avatar",attrs:{size:40,src:(null===(o=s.student)||void 0===o?void 0:o.avatar)||t.defaultAvatar}}),e("div",{staticClass:"request-info"},[e("span",{staticClass:"student-name"},[t._v(t._s((null===(n=s.student)||void 0===n?void 0:n.name)||"未知学生"))]),e("span",{staticClass:"request-details"},[t._v(t._s(s.topic||"请求聊天")+" - "+t._s(t.formatTimeAgo(s.createdAt)))])]),e("el-button",{attrs:{type:"success",size:"mini",icon:"el-icon-view",circle:"",title:"查看并处理"},on:{click:function(e){return t.viewRequest(s)}}})],1)})),0):e("div",{staticClass:"empty-state"},[t._v(" 当前没有待处理的辅导请求。 ")])])],1)])],1)],1)],1)},n=[],a=(s("14d9"),s("bc3a")),i=s.n(a);function c(t){if(!t)return"N/A";const e=t instanceof Date?t:new Date(t);if(isNaN(e.getTime()))return"Invalid Date";const s=e.getFullYear(),o=String(e.getMonth()+1).padStart(2,"0"),n=String(e.getDate()).padStart(2,"0");return`${s}-${o}-${n}`}function l(t){if(!t)return"N/A";const e=t instanceof Date?t:new Date(t);if(isNaN(e.getTime()))return"Invalid Date";const s=Math.floor((new Date-e)/1e3);let o=Math.floor(s/31536e3);return o>1?o+" years ago":(o=Math.floor(s/2592e3),o>1?o+" months ago":(o=Math.floor(s/86400),o>1?o+" days ago":(o=Math.floor(s/3600),o>1?o+" hours ago":(o=Math.floor(s/60),o>1?o+" minutes ago":s<10?"just now":Math.floor(s)+" seconds ago"))))}var r=s("daa8"),d=s("2b0e");const u="http://localhost:3000",h=d["default"].observable({isConnected:!1,socketId:null,connectionError:null});let g=null,p=0;const v=5,m=t=>{if(g&&g.connected)return void console.log("Socket already connected.");console.log(`Attempting to connect to WebSocket at ${u}...`),g&&g.disconnect(),h.connectionError=null;const e={auth:t?{token:t}:void 0,transports:["websocket","polling"],reconnectionAttempts:v,reconnectionDelay:1e3,reconnectionDelayMax:5e3,timeout:2e4};console.log("Socket.io 连接配置:",e);try{g=Object(r["b"])(u,e),g.on("connect",()=>{h.isConnected=!0,h.socketId=g.id,h.connectionError=null,p=0,console.log("WebSocket 连接成功:",g.id)}),g.on("disconnect",t=>{h.isConnected=!1,h.socketId=null,console.log("WebSocket 连接断开:",t)}),g.on("connect_error",t=>{h.isConnected=!1,p++,h.connectionError=t.message,console.error(`WebSocket 连接错误 (尝试 ${p}/${v}):`,t),p>=v&&(console.error("达到最大重连次数，放弃连接WebSocket"),g.disconnect())}),g.on("newStudentRequest",t=>{console.log("收到新的学生请求:",t)}),g.on("receiveMessage",t=>{console.log("Received message:",t)})}catch(s){console.error("创建WebSocket连接时发生错误:",s),h.connectionError=s.message}},C=()=>{g&&(g.disconnect(),h.isConnected=!1,h.socketId=null)},f=(t,e)=>{g&&h.isConnected?g.emit(t,e):console.warn("Socket未连接。无法发送事件:",t)},q=(t,e)=>{f("sendMessage",{roomId:t,text:e})},b=(t,e)=>{f("acceptRequest",{requestId:t,studentId:e})},k=t=>{f("rejectRequest",{requestId:t})};var w={state:h,connect:m,disconnect:C,emitEvent:f,sendMessage:q,acceptRequest:b,rejectRequest:k},_={name:"TeacherDashboard",data(){return{loading:{stats:!1,videos:!1,requests:!1},teacherName:"",videoCount:0,pendingRequestCount:0,processedRequestCount:0,recentVideos:[],pendingRequests:[],defaultAvatar:"https://cube.elemecdn.com/3/7c/3ea6beec64369c2642b92c6726f1epng.png"}},methods:{formatDate:c,formatTimeAgo:l,async fetchDashboardData(){console.log("Executing fetchDashboardData..."),this.loading.stats=!0,this.loading.videos=!0,this.loading.requests=!0;try{const t=await i.a.get("/teacher/dashboard"),e=t.data;this.teacherName=e.teacherName||"老师",this.videoCount=e.videoCount||0,this.pendingRequestCount=e.pendingRequestCount||0,this.processedRequestCount=e.processedRequestCount||0,this.recentVideos=e.recentVideos||[],this.pendingRequests=e.pendingRequests||[]}catch(t){console.error("Error fetching dashboard data:",t),this.$message.error("无法加载仪表盘数据")}finally{this.loading.stats=!1,this.loading.videos=!1,this.loading.requests=!1}},async fetchConsultationStats(){try{const t=await i.a.get("/api/consultations/requests");t.data&&(this.pendingRequestCount=t.data.pending.length,this.processedRequestCount=t.data.completed.length,this.pendingRequests=t.data.pending.slice(0,5))}catch(t){console.error("Error fetching consultation stats:",t)}},goToResources(){this.$router.push("/resources")},goToPendingConsultations(){this.$router.push({path:"/consultations",query:{tab:"0"}})},editVideo(t){this.$message("编辑视频功能待实现: "+t)},viewRequest(t){this.$router.push({path:"/consultations",query:{tab:"0",requestId:t.id}})},setupSocketListeners(){var t,e,s,o;if(!w.state.isConnected){const t=localStorage.getItem("teacherToken");t&&w.connect(t)}null===(t=w.socket)||void 0===t||t.on("new_consultation_request",this.handleNewRequest),null===(e=w.socket)||void 0===e||e.on("pending_requests",this.handlePendingRequests),null===(s=w.socket)||void 0===s||s.on("completed_requests",this.handleCompletedRequests),null===(o=w.socket)||void 0===o||o.on("consultation_stats",this.handleConsultationStats)},removeSocketListeners(){var t,e,s,o;null===(t=w.socket)||void 0===t||t.off("new_consultation_request",this.handleNewRequest),null===(e=w.socket)||void 0===e||e.off("pending_requests",this.handlePendingRequests),null===(s=w.socket)||void 0===s||s.off("completed_requests",this.handleCompletedRequests),null===(o=w.socket)||void 0===o||o.off("consultation_stats",this.handleConsultationStats)},handleNewRequest(t){console.log("收到新的咨询请求:",t),this.pendingRequestCount++,this.pendingRequests.unshift(t),this.pendingRequests.length>5&&this.pendingRequests.pop(),this.$notify({title:"新的咨询请求",message:`学生 ${t.studentName} 发送了一个新的咨询请求`,type:"info",position:"bottom-right",duration:5e3})},handlePendingRequests(t){console.log("待处理请求列表更新:",t),this.pendingRequestCount=t.length,this.pendingRequests=t.slice(0,5)},handleCompletedRequests(t){console.log("已完成请求列表更新:",t),this.processedRequestCount=t.length},handleConsultationStats(t){console.log("咨询统计数据更新:",t),this.pendingRequestCount=t.pending,this.processedRequestCount=t.completed}},created(){console.log("Home.vue component created."),this.fetchDashboardData(),this.setupSocketListeners()},mounted(){w.state.isConnected&&w.socket&&w.socket.emit("authenticate",{userId:localStorage.getItem("teacherId")||"unknown",role:"teacher"})},beforeDestroy(){this.removeSocketListeners()}},R=_,y=(s("69db"),s("2877")),S=Object(y["a"])(R,o,n,!1,null,"6a3258c2",null);e["default"]=S.exports},f2db:function(t,e,s){}}]);
//# sourceMappingURL=chunk-750c3616.92686853.js.map